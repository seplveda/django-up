#!/bin/bash

set -e
LOGFILE=/srv/www/{{ app_name }}/logs/{{ app_name }}.log
LOGDIR=$(dirname $LOGFILE)
NUM_WORKERS={{ gunicorn_workers }}

# user/group to run as
USER={{ app_name }}
GROUP={{ app_name }}

{% for variable_name, value in django_environment.items() %}
export {{ variable_name }}="{{ value }}"
{% endfor %}
export DATABASE_URL="postgres://{{ app_name }}:{{ db_password }}@localhost:5432/{{ app_name }}"

cd /srv/www/{{ app_name }}/code
source /srv/www/{{ app_name }}/venv/bin/activate

test -d $LOGDIR || mkdir -p $LOGDIR

exec gunicorn {{ app_name }}.wsgi:application -w $NUM_WORKERS \
  --timeout=300 --user=$USER --group=$GROUP --log-level=debug \
  {% if gunicorn_port %}-b localhost:{{ gunicorn_port }}{% endif %} --log-file=$LOGFILE 2>> $LOGFILE
